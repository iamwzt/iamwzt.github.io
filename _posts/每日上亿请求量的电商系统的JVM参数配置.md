### 问题
每日上亿请求量的电商系统，需要怎么去调优JVM？

### 分析
每日上亿请求量的电商系统，看似多，实际分析下来每秒的下单量其实也就几十，下面来看看分析过程：

1. 每日上亿请求量，若每个用户*平均访问20次*，则**日活用户量约为500W**；
2. 若*付费转化率为10%*，则**每日订单量为50W**；
3. 假设订单集中在4个小时里，则每秒的订单数就只有**几十**了。

假设一个订单对象本身占1k，算上连带的订单条目、库存、促销、优惠券等其他业务的对象，往大了估，开销乘个20吧；

除下单之外，还有查询订单等其他相关的操作，再乘个10吧；

这样每个订单有 `1k * 20 * 10`，约为 **0.2M** 的内存开销。

这种情况下，每秒几十个订单，也就是是不到10M的内存开销，新生代很久才会满，一个Minor GC就清理干净了，不会有什么压力。

但是，如果考虑大促场景，可能在10分钟内就有50W订单了，此时每秒订单数就有近千，换成内存来说，就是每秒有数百M的开销。此时就应该考虑优化的问题了。

为了抗住大促期间的瞬时下单压力，首先要考虑多台机器去抗住压力。这里采用3台**4核8G内存的机器**，每台抗300订单。接下来就进入正题。

### 内存使用模型估算
一台8G的机器，考虑分配4G内存给JVM，具体如下：
- 新生代：1.5G
- 老年代：1.5G
- 永久代：256M
- 虚拟机栈：1M/线程 × 几百线程

这样一算，4G基本用完了。JVM参数如下：
```
-Xms3072M
-Xmx3072M
-Xmn1536M
-Xss1M
-XX:PermSize=256M
-XX:MaxPermSize=256M
```

每台机器300订单/秒，即60M/秒。
此时新生代大小为1.5G，由于默认的 `-XX:SurvivorRatio` 为8，即Eden区约1.2G，那么20秒的时间，Eden就会满，需要进行Minor GC了。

GC后存活对象假设有100M，放入Survivor区，此后若没有意外都是如此。

### 减少对象进入老年代：调整Survivor大小
等等，我们的Survivor区的大小为150M，如果每次都放入100M，那么根据**大于某个年龄的对象占空间过半则入老年代**的规则，每次都有对象进入老年代，这明显不合理（每个对象实际生命周期只有1秒左右）。

因此我们要在此处进行优化，这里可以优先考虑**调整新生代和老年代的比例**。还是因为对象生命周期短的原因，没必要进入老年代。
考虑将新生代调整为2G，老年代1G，这样Survivor区就有200M了，降低了对象进入老年代的概率。JVM参数如下：
```
-Xms3072M
-Xmx3072M
-Xmn2048M
-Xss1M
-XX:PermSize=256M
-XX:MaxPermSize=256M
-XX:SurvivorRatio=8
```
### 加快对象进入老年代：年龄阈值和大小阈值
根据进入老年代的规则，在新生代经历过15次（默认）垃圾回收的对象要进入老年代。在我们这个场景里，20多秒一次GC，15次已经好几分钟了，也确实应该进入老年代了。

所以这里要加快的是那些生命周期长的，确实需要进入老年代的对象，如Controller、Service等。早点进就没必要占用新生代的空间了。

此外，对于大对象，也要设置一个合理的阈值，让其直接进入老年代。此时JVM参数如下：
```
-Xms3072M
-Xmx3072M
-Xmn2048M
-Xss1M
-XX:PermSize=256M
-XX:MaxPermSize=256M
-XX:SurvivorRatio=8
-XX:MaxTenuringThreshold=5
-XX:PretenureSize=1M
```

### 最后，记得指定垃圾回收器
```
-Xms3072M
-Xmx3072M
-Xmn2048M
-Xss1M
-XX:PermSize=256M
-XX:MaxPermSize=256M
-XX:SurvivorRatio=8
-XX:MaxTenuringThreshold=5
-XX:PretenureSize=1M
-XX:+UseParNewGC
-XX:+UseConcMarkSweepGC
```
指定新生代用 ParNew ，老年代用 CMS。
